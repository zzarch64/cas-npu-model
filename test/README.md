# CAS-NPU æµ‹è¯•å¥—ä»¶

æœ¬ç›®å½•åŒ…å« CAS-NPU æ‰©å±•çš„å®Œæ•´æµ‹è¯•å¥—ä»¶ï¼Œç”¨äºéªŒè¯è‡ªå®šä¹‰è®¾å¤‡çš„åŠŸèƒ½å’Œæ­£ç¡®æ€§ã€‚

## ğŸ“‹ æµ‹è¯•æ–‡ä»¶æ¦‚è§ˆ

### 1. `test_concept.py` - æ¦‚å¿µéªŒè¯æµ‹è¯•
**ç”¨é€”**: çº¯ Python å®ç°çš„æ¦‚å¿µéªŒè¯ï¼Œæ— éœ€ç¼–è¯‘ C++ æ‰©å±•

**ç‰¹ç‚¹**:
- ä½¿ç”¨ NumPy æ¨¡æ‹Ÿ CAS-NPU è®¾å¤‡æ“ä½œ
- éªŒè¯ PrivateUse1 æœºåˆ¶çš„è®¾è®¡æ­£ç¡®æ€§
- æ‰‹åŠ¨æ³¨å†Œæ“ä½œå®ç°ï¼ˆä½¿ç”¨ `@torch.library.impl` è£…é¥°å™¨ï¼‰

**æµ‹è¯•å†…å®¹**:
- åŸºæœ¬ CAS-NPU æ“ä½œï¼ˆadd, mul ç­‰ï¼‰
- Tensor æ–¹æ³•ç”ŸæˆéªŒè¯
- è®¾å¤‡æ³¨å†Œå’Œå¯ç”¨æ€§æ£€æŸ¥

**è¿è¡Œæ–¹å¼**:
```bash
python test/test_concept.py
```

**é€‚ç”¨åœºæ™¯**: 
- åœ¨ç¼–è¯‘ C++ æ‰©å±•ä¹‹å‰éªŒè¯è®¾è®¡æ€è·¯
- å¿«é€ŸéªŒè¯ PrivateUse1 æœºåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œ

---

### 2. `test_cas_npu.py` - åŸºç¡€åŠŸèƒ½æµ‹è¯•
**ç”¨é€”**: æµ‹è¯• CAS-NPU æ‰©å±•çš„åŸºç¡€åŠŸèƒ½

**æµ‹è¯•å†…å®¹**:
1. **è®¾å¤‡å¯ç”¨æ€§æ£€æŸ¥** (`test_device_availability`)
   - æ£€æŸ¥è®¾å¤‡æ˜¯å¦å¯ç”¨
   - éªŒè¯è®¾å¤‡æ•°é‡

2. **Tensor åˆ›å»ºå’Œè®¾å¤‡è½¬ç§»** (`test_tensor_creation`)
   - åœ¨ CPU ä¸Šåˆ›å»º Tensor
   - è½¬ç§»åˆ° cas_npu è®¾å¤‡
   - éªŒè¯è®¾å¤‡ç±»å‹

3. **add.Tensor æ“ä½œ** (`test_add_tensor`)
   - æµ‹è¯•è‡ªå®šä¹‰å®ç°çš„åŠ æ³•æ“ä½œ
   - éªŒè¯ç»“æœæ­£ç¡®æ€§

4. **è®¾å¤‡åˆ‡æ¢** (`test_device_switching`)
   - æµ‹è¯•å¤šè®¾å¤‡åˆ‡æ¢åŠŸèƒ½
   - éªŒè¯è®¾å¤‡çŠ¶æ€ç®¡ç†

5. **Tensor æ–¹æ³•** (`test_tensor_methods`)
   - éªŒè¯è‡ªåŠ¨ç”Ÿæˆçš„ Tensor æ–¹æ³•ï¼ˆå¦‚ `is_cas_npu`ï¼‰

**è¿è¡Œæ–¹å¼**:
```bash
python test/test_cas_npu.py
```

**å‰ç½®æ¡ä»¶**: 
- éœ€è¦å…ˆç¼–è¯‘ C++ æ‰©å±•ï¼ˆ`python setup.py build_ext --inplace`ï¼‰

---

### 3. `test_lenet.py` - LeNet ç¥ç»ç½‘ç»œæµ‹è¯•
**ç”¨é€”**: éªŒè¯å®Œæ•´çš„ç¥ç»ç½‘ç»œå‰å‘ä¼ æ’­å’Œ CPU Fallback æœºåˆ¶

**ç‰¹ç‚¹**:
- å®ç°å®Œæ•´çš„ LeNet ç½‘ç»œç»“æ„
- æ¼”ç¤º CPU Fallback æœºåˆ¶ï¼ˆæœªå®ç°çš„æ“ä½œè‡ªåŠ¨å›é€€åˆ° CPUï¼‰
- éªŒè¯ add æ“ä½œä½¿ç”¨ CAS-NPU å®ç°

**æµ‹è¯•å†…å®¹**:
1. **CPU åŸºå‡†æµ‹è¯•** (`test_lenet_on_cpu`)
   - åœ¨ CPU ä¸Šè¿è¡Œ LeNetï¼Œä½œä¸ºå‚è€ƒåŸºå‡†

2. **CAS-NPU æµ‹è¯•** (`test_lenet_on_cas_npu`)
   - åœ¨ cas_npu è®¾å¤‡ä¸Šè¿è¡Œ LeNet
   - éªŒè¯å‰å‘ä¼ æ’­åŠŸèƒ½

3. **è¾“å‡ºä¸€è‡´æ€§éªŒè¯** (`test_output_consistency`)
   - æ¯”è¾ƒ CPU å’Œ CAS-NPU çš„è¾“å‡ºç»“æœ
   - ç¡®ä¿æ•°å€¼æ­£ç¡®æ€§

4. **add æ“ä½œéªŒè¯** (`test_add_operation`)
   - éªŒè¯ add æ“ä½œç¡®å®ä½¿ç”¨äº† CAS-NPU å®ç°

5. **å¤šæ“ä½œæµ‹è¯•** (`test_multiple_operations`)
   - æµ‹è¯•å¤šä¸ªè¿ç»­æ“ä½œçš„æ­£ç¡®æ€§

**è¿è¡Œæ–¹å¼**:
```bash
python test/test_lenet.py
```

**æ³¨æ„äº‹é¡¹**:
- å¤§éƒ¨åˆ†æ“ä½œï¼ˆå¦‚å·ç§¯ï¼‰ä¼š fallback åˆ° CPU æ‰§è¡Œ
- åªæœ‰å·²å®ç°çš„æ“ä½œï¼ˆå¦‚ addï¼‰ä¼šåœ¨ CAS-NPU ä¸Šæ‰§è¡Œ

---

### 4. `test_lenet_training.py` - LeNet è®­ç»ƒæµ‹è¯•
**ç”¨é€”**: éªŒè¯åå‘ä¼ æ’­ã€æ¢¯åº¦è®¡ç®—å’Œè®­ç»ƒæµç¨‹

**ç‰¹ç‚¹**:
- ä½¿ç”¨ MSELoss é¿å… log_softmax ç›¸å…³é—®é¢˜
- å®ç°å®Œæ•´çš„è®­ç»ƒå¾ªç¯
- éªŒè¯æ¢¯åº¦è®¡ç®—å’Œå‚æ•°æ›´æ–°

**æµ‹è¯•å†…å®¹**:
1. **add åå‘ä¼ æ’­** (`test_add_backward`)
   - æµ‹è¯• add æ“ä½œçš„æ¢¯åº¦è®¡ç®—

2. **çº¿æ€§å±‚åå‘ä¼ æ’­** (`test_linear_backward`)
   - æµ‹è¯• Linear å±‚çš„åå‘ä¼ æ’­

3. **å·ç§¯å±‚åå‘ä¼ æ’­** (`test_conv_backward`)
   - æµ‹è¯• Conv2d å±‚çš„åå‘ä¼ æ’­

4. **å®Œæ•´è®­ç»ƒæµç¨‹** (`test_lenet_training`)
   - å®ç°å®Œæ•´çš„è®­ç»ƒå¾ªç¯
   - éªŒè¯æŸå¤±ä¸‹é™å’Œå‚æ•°æ›´æ–°

5. **æ¢¯åº¦ç´¯ç§¯** (`test_gradient_accumulation`)
   - æµ‹è¯•æ¢¯åº¦ç´¯ç§¯åŠŸèƒ½

**è¿è¡Œæ–¹å¼**:
```bash
python test/test_lenet_training.py
```

**å‰ç½®æ¡ä»¶**:
- éœ€è¦å®ç° AutogradPrivateUse1 ç›¸å…³çš„åå‘ä¼ æ’­æ“ä½œ

---

### 5. `test_qwen0.5B.py` - Qwen æ¨¡å‹æµ‹è¯•
**ç”¨é€”**: éªŒè¯çŸ©é˜µä¹˜æ³•ï¼ˆmmï¼‰å’Œæ‰¹é‡çŸ©é˜µä¹˜æ³•ï¼ˆbmmï¼‰ç®—å­å®ç°

**ç‰¹ç‚¹**:
- æµ‹è¯•çœŸå®çš„å¤§è¯­è¨€æ¨¡å‹ï¼ˆQwen 0.5Bï¼‰
- éªŒè¯ mm å’Œ bmm ç®—å­çš„æ­£ç¡®æ€§
- æµ‹è¯• Transformer æ¶æ„çš„å…³é”®æ“ä½œ

**æµ‹è¯•å†…å®¹**:
1. **åŸºç¡€ mm å’Œ bmm æ“ä½œ** (`test_mm_bmm_basic`)
   - æµ‹è¯•çŸ©é˜µä¹˜æ³•çš„åŸºæœ¬åŠŸèƒ½
   - éªŒè¯æ‰¹é‡çŸ©é˜µä¹˜æ³•

2. **Qwen æ¨¡å‹æµ‹è¯•** (`test_qwen_model`)
   - åŠ è½½ Qwen 0.5B æ¨¡å‹
   - å°†æ¨¡å‹å‚æ•°è½¬ç§»åˆ° cas_npu è®¾å¤‡
   - è¿è¡Œå‰å‘ä¼ æ’­
   - éªŒè¯è¾“å‡ºæ­£ç¡®æ€§

3. **çº¿æ€§å±‚æµ‹è¯•** (`test_linear_layer`)
   - å•ç‹¬æµ‹è¯• Linear å±‚åœ¨ CAS-NPU ä¸Šçš„è¡¨ç°

**è¿è¡Œæ–¹å¼**:
```bash
python test/test_qwen0.5B.py
```

**å‰ç½®æ¡ä»¶**:
- éœ€è¦å®‰è£… `transformers` åº“: `pip install transformers`
- éœ€è¦å®ç° `mm` å’Œ `bmm` ç®—å­ï¼ˆåœ¨ `cas_npu_ops.cpp` ä¸­ï¼‰

**æ³¨æ„äº‹é¡¹**:
- é¦–æ¬¡è¿è¡Œä¼šä¸‹è½½æ¨¡å‹æƒé‡ï¼ˆçº¦ 1GBï¼‰
- æ¨¡å‹æ¨ç†å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¼–è¯‘æ‰©å±•
åœ¨è¿è¡Œæµ‹è¯•ä¹‹å‰ï¼Œéœ€è¦å…ˆç¼–è¯‘ C++ æ‰©å±•ï¼š

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•
python setup.py build_ext --inplace
```

### 2. è¿è¡Œæ‰€æœ‰æµ‹è¯•
```bash
# è¿è¡ŒåŸºç¡€æµ‹è¯•
python test/test_cas_npu.py

# è¿è¡Œæ¦‚å¿µéªŒè¯ï¼ˆæ— éœ€ç¼–è¯‘ï¼‰
python test/test_concept.py

# è¿è¡Œç¥ç»ç½‘ç»œæµ‹è¯•
python test/test_lenet.py

# è¿è¡Œè®­ç»ƒæµ‹è¯•
python test/test_lenet_training.py

# è¿è¡Œæ¨¡å‹æµ‹è¯•ï¼ˆéœ€è¦ transformersï¼‰
python test/test_qwen0.5B.py
```

### 3. ä½¿ç”¨æ„å»ºè„šæœ¬
é¡¹ç›®æ ¹ç›®å½•æä¾›äº† `build_and_test.sh` è„šæœ¬ï¼Œå¯ä»¥è‡ªåŠ¨ç¼–è¯‘å¹¶è¿è¡Œæµ‹è¯•ï¼š

```bash
./build_and_test.sh
```

---

## ğŸ“ æµ‹è¯•ä¾èµ–

### å¿…éœ€ä¾èµ–
- PyTorch (>= 1.13.0)
- NumPy

### å¯é€‰ä¾èµ–
- `transformers` - ç”¨äº Qwen æ¨¡å‹æµ‹è¯•
  ```bash
  pip install transformers
  ```

---

## ğŸ” æµ‹è¯•è¦†ç›–èŒƒå›´

| æµ‹è¯•æ–‡ä»¶ | è®¾å¤‡æ³¨å†Œ | åŸºç¡€æ“ä½œ | ç¥ç»ç½‘ç»œ | è®­ç»ƒ | å¤§æ¨¡å‹ |
|---------|---------|---------|---------|------|--------|
| `test_concept.py` | âœ… | âœ… | âŒ | âŒ | âŒ |
| `test_cas_npu.py` | âœ… | âœ… | âŒ | âŒ | âŒ |
| `test_lenet.py` | âœ… | âœ… | âœ… | âŒ | âŒ |
| `test_lenet_training.py` | âœ… | âœ… | âœ… | âœ… | âŒ |
| `test_qwen0.5B.py` | âœ… | âœ… | âœ… | âŒ | âœ… |

---

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ 1: å¯¼å…¥é”™è¯¯
```
ImportError: Failed to import CAS-NPU extension
```
**è§£å†³æ–¹æ¡ˆ**: ç¡®ä¿å·²ç¼–è¯‘ C++ æ‰©å±•ï¼Œè¿è¡Œ `python setup.py build_ext --inplace`

### é—®é¢˜ 2: è®¾å¤‡ä¸å¯ç”¨
```
AssertionError: CAS-NPU device should be available
```
**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥è¿è¡Œæ—¶æ¨¡æ‹Ÿå™¨æ˜¯å¦æ­£ç¡®åˆå§‹åŒ–ï¼ˆcmodel æˆ– fpgaï¼‰

### é—®é¢˜ 3: transformers æœªå®‰è£…
```
ImportError: No module named 'transformers'
```
**è§£å†³æ–¹æ¡ˆ**: å®‰è£… transformers åº“: `pip install transformers`

### é—®é¢˜ 4: æ“ä½œæœªå®ç°
```
RuntimeError: Could not run 'aten::xxx' with arguments from the 'PrivateUse1' backend
```
**è§£å†³æ–¹æ¡ˆ**: è¯¥æ“ä½œå°šæœªåœ¨ C++ ä¸­å®ç°ï¼Œéœ€è¦æ·»åŠ å¯¹åº”çš„å®ç°æˆ–ä½¿ç”¨ CPU Fallback

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä¸» README](../README.md) - é¡¹ç›®æ€»ä½“ä»‹ç»
- [MM_BMM å®ç°æ–‡æ¡£](../MM_BMM_IMPLEMENTATION.md) - çŸ©é˜µä¹˜æ³•å®ç°ç»†èŠ‚
- [PyTorch PrivateUse1 æ–‡æ¡£](https://pytorch.org/tutorials/advanced/extend_dispatcher.html) - PyTorch å®˜æ–¹æ–‡æ¡£

---

## ğŸ’¡ å¼€å‘å»ºè®®

1. **å¼€å‘æ–°åŠŸèƒ½æ—¶**: å…ˆè¿è¡Œ `test_concept.py` éªŒè¯è®¾è®¡ï¼Œå†å®ç° C++ ç‰ˆæœ¬
2. **æ·»åŠ æ–°æ“ä½œæ—¶**: åœ¨ `test_cas_npu.py` ä¸­æ·»åŠ å¯¹åº”çš„å•å…ƒæµ‹è¯•
3. **æµ‹è¯•å¤æ‚æ¨¡å‹æ—¶**: ä½¿ç”¨ `test_lenet.py` ä½œä¸ºæ¨¡æ¿
4. **éªŒè¯è®­ç»ƒåŠŸèƒ½æ—¶**: å‚è€ƒ `test_lenet_training.py` çš„å®ç°

---

## ğŸ“„ è®¸å¯è¯

ä¸ä¸»é¡¹ç›®ä¿æŒä¸€è‡´ã€‚
